#include "../inc/types.h"
#include "../inc/loop.h"

/*calcula a Quantizacao direta para blocos 4x4*/

short int **quantize(short int **block) {
    int i, j, f;
    short int **q, qbits, temp;
    short int MF[6][4][4] = { //Matriz de Constantes
        //QP % 6 = 0
        {{13107, 8066, 13107, 8066},
         {8066, 5243, 8066, 5243},
         {13107, 8066, 13107, 8066},
         {8066, 5243, 8066, 5243}},
        //QP % 6 = 1
        {{11916, 7490, 11916, 7490},
         {7490, 4660, 7490, 4660},
         {11916, 7490, 11916, 7490},
         {7490, 4660, 7490, 4660}},
        //QP % 6 = 2
        {{10082, 6554, 10082, 6554},
         {6554, 4194, 6554, 4194},
         {10082, 6554, 10082, 6554},
         {6554, 4194, 6554, 4194}},
        //QP % 6 = 3
        {{9362, 5825, 9362, 5825},
         {5825, 3647, 5825, 3647},
         {9362, 5825, 9362, 5825},
         {5825, 3647, 5825, 3647}},
        //QP % 6 = 4
        {{8192, 5243, 8192, 5243},
         {5243, 3355, 5243, 3355},
         {8192, 5243, 8192, 5243},
         {5243, 3355, 5243, 3355}},
        //QP % 6 = 5
        {{7282, 4559, 7282, 4559},
         {4559, 2893, 4559, 2893},
         {7282, 4559, 7282, 4559},
         {4559, 2893, 4559, 2893}}};

    q = malloc_matrix(4, 4);
    qbits = 15 + floor(QP / 6);
    f = (1 << qbits) / 6;

    for (i = 0; i < 4; i++) {
        for (j = 0; j < 4; j++) {
            temp = (abs(block[i][j]) * MF[QP % 6][i][j] + f) >> qbits;
            if (block[i][j] >= 0)
                q[i][j] = temp;
            else
                q[i][j] = -temp;
        }
    }
    return q;
}

